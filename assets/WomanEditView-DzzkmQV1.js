import{r as i,j as e}from"./index-DJ0IS-oA.js";import{a as u}from"./axios-upsvKRUO.js";import{A as Z}from"./AppBar-CL-OfsFA.js";import{C as ee}from"./CopyrightFooter-BTH_ji-_.js";function ne(){const[te,L]=i.useState(null),[p,M]=i.useState(null),[l,h]=i.useState(null),[N,x]=i.useState(""),[y,f]=i.useState(Array(6).fill(null).map(()=>({image_url:null}))),[_,k]=i.useState([]),m=["不約見","不聊色","不電愛","熟了有機會"],[j,A]=i.useState(new Array(m.length).fill(!1)),g=["高挑","小隻馬","清純","性感","可愛","氣質","活力","古典美","時尚","陽光","甜美","纖細","健康","俏皮","短髮","豐滿","OL","運動","成熟"],[b,w]=i.useState(new Array(g.length).fill(!1)),[v,S]=i.useState(""),[C,R]=i.useState(""),[I,T]=i.useState(!1),[B,O]=i.useState(null),[W,$]=i.useState([]),[E,F]=i.useState(null),[U,z]=i.useState(null),[P,V]=i.useState("");i.useEffect(()=>{const r=window.sessionStorage.getItem("token")||"",s=window.sessionStorage.getItem("u_id")||"";M(r),L(s),r&&s&&(D(r),Y(r,s))},[]);async function D(r){try{const s=await u.get("https://api.dageiwo.com/auth/info",{headers:{Authorization:`Bearer ${r}`}});if(s.status===200&&s.data.success){const t=s.data.data;if(h(t),t.female_response){const n=(t.female_response.statement||"").split(",");A(m.map(d=>n.includes(d)));const c=(t.female_response.appearance||"").split(",");w(g.map(d=>c.includes(d))),t.female_response.about_me&&R(t.female_response.about_me)}}}catch(s){console.error("RetrieveInfo error:",s)}}async function Y(r,s){try{const t=await u.get(`https://api.dageiwo.com/index/detail/${s}`,{headers:{Authorization:`Bearer ${r}`}});if(t.status===200&&t.data.success){const a=t.data.data;let n=a.img_responses.map(o=>({file_id:o.file_id,image_url:o.image_url,status:o.status,file:null}));if(n.length<6){const o=6-n.length;for(let c=0;c<o;c++)n.push({file_id:null,image_url:null,status:"EMPTY"})}f(n),h(o=>({...o,...a}))}}catch(t){console.error("getInfo error:",t)}}async function q(r,s){if(window.confirm("確定要刪除這張圖片嗎？")){if(!r){f(a=>{const n=[...a];return n.splice(s,1),n});return}try{(await u.delete(`https://api.dageiwo.com/api/user/file?file_id=${r}`,{headers:{Authorization:`Bearer ${p}`}})).status===200?(f(n=>{const o=[...n];return o.splice(s,1),o}),alert("圖片刪除成功！")):alert("刪除失敗，請重試！")}catch(a){console.error(a),alert("刪除失敗，請檢查網路連線後重試！")}}}async function G(){const r=y.filter(t=>t.file),s=y.filter(t=>!t.file&&t.file_id);if(r.length>0){const t=new FormData;r.forEach(a=>{t.append("files",a.file)});try{const a=await u.post("https://api.dageiwo.com/file/upload_multi?file_type=AVATAR",t,{headers:{"Content-Type":"multipart/form-data",Authorization:`Bearer ${p}`}});if(a.status===200&&a.data.success)console.log("上傳成功:",a.data),a.data.data.forEach(n=>{k(o=>[...o,n.id])});else return console.error("上傳失敗:",a.data.message),alert("圖片上傳失敗，請重試！"),!1}catch(a){return console.error("上傳失敗:",a),alert("上傳失敗，請檢查網路連線後重試！"),!1}}return s.forEach(t=>{t.file_id&&k(a=>[...a,t.file_id])}),console.log("最終文件ID列表:",_),!0}function H(){if(!navigator.mediaDevices){alert("您的設備不支援錄音");return}navigator.mediaDevices.getUserMedia({audio:!0}).then(r=>{const s=new MediaRecorder(r);O(s),$([]),s.ondataavailable=t=>{$(a=>[...a,t.data])},s.onstop=()=>{const t=new Blob(W,{type:"audio/webm"}),a=URL.createObjectURL(t);F(t),z(a)},s.start(),T(!0)}).catch(r=>{console.error("錄音失敗:",r),alert("無法啟動錄音功能，請檢查瀏覽器權限設定！")})}function J(){B&&(B.stop(),T(!1))}function K(){F(null),z(null),alert("錄音已捨棄，請重新錄製！")}async function Q(){if(!E){alert("無錄音文件可上傳");return}try{const r=new FormData;r.append("file",E,"recording.webm"),r.append("fileType","AVATAR");const s=await u.post("https://api.dageiwo.com/file/upload",r,{headers:{"Content-Type":"multipart/form-data",Authorization:`Bearer ${p}`}});if(s.status===200&&s.data.success){const t=s.data.data.id;console.log("錄音上傳成功, fileId=",t),V(t)}else alert("錄音上傳失敗："+s.data.message),console.error("錄音上傳失敗:",s.data.message)}catch(r){alert("錄音上傳失敗，請稍後再試！"),console.error("錄音上傳失敗:",r)}}async function X(){if(x(""),!await G())return;let s="";m.forEach((o,c)=>{j[c]&&(s+=(s?",":"")+o)});let t="";g.forEach((o,c)=>{b[c]&&(t+=(t?",":"")+o)});const a=_.join(","),n=(l==null?void 0:l.about_me)||C;try{const o=await u.put("https://api.dageiwo.com/api/user",{statement:s,appearance:t,about_me:n,file_ids:a,mp3_id:P},{headers:{Authorization:`Bearer ${p}`}});o.status===200&&o.data.success?(alert("更新檔案成功"),D(p)):x("更新檔案發生錯誤, 請檢查網路後重試一次.")}catch(o){console.error("UpdateInfo error:",o),x("更新檔案發生錯誤, 請檢查網路後重試一次.")}}return e.jsxs(e.Fragment,{children:[e.jsx(Z,{children:e.jsx("button",{style:{background:"none",border:"none",color:"#fff"},onClick:()=>window.history.back(),children:e.jsx("i",{className:"mdi mdi-chevron-left",style:{fontSize:"24px"}})})}),e.jsxs("div",{className:"register-main",style:{backgroundColor:"#fff",maxWidth:"600px",margin:"0 auto",padding:"1rem"},children:[e.jsx("h2",{style:{color:"dodgerblue",textAlign:"center"},children:"編輯個人檔案"}),e.jsx("hr",{}),e.jsx("div",{style:{margin:"5px 0"},children:"上傳頭像(最少1張，可同時選多個)"}),e.jsxs("div",{className:"female-member-list",children:[y.map((r,s)=>e.jsx("div",{children:e.jsxs("div",{style:{position:"relative",height:"200px",borderRadius:"12px",border:"1px solid #ccc",display:"flex",alignItems:"center",justifyContent:"center",cursor:"pointer"},onClick:()=>{const t=document.getElementById(`uploadInput${s}`);t&&t.click()},children:[r.image_url?e.jsx("img",{src:r.image_url,alt:"preview",style:{width:"100%",height:"100%",objectFit:"cover"}}):e.jsx("div",{style:{textAlign:"center",color:"#888"},children:"點擊上傳圖片"}),e.jsx("input",{type:"file",id:`uploadInput${s}`,style:{display:"none"},accept:"image/*",onChange:t=>{const a=t.target.files[0];if(!a)return;const n=new FileReader;n.onload=o=>{f(c=>{const d=[...c];return d[s]={...d[s],file:a,image_url:o.target.result},d})},n.readAsDataURL(a)}}),e.jsx("button",{style:{position:"absolute",top:"5px",right:"5px",background:"rgba(255, 255, 255, 0.8)",borderRadius:"50%",border:"none",cursor:"pointer"},onClick:t=>{t.stopPropagation(),q(r.file_id,s)},children:e.jsx("i",{className:"mdi mdi-delete",style:{fontSize:"18px"}})})]})},s)),e.jsx("div",{children:e.jsx("div",{style:{border:"1px dashed #ccc",borderRadius:"12px",width:"100%",height:"200px",display:"flex",alignItems:"center",justifyContent:"center",cursor:"pointer"},onClick:()=>{f(r=>[...r,{file_id:null,image_url:null}])},children:e.jsx("i",{className:"mdi mdi-plus",style:{fontSize:"36px",color:"#666"}})})})]}),e.jsx("div",{style:{margin:"10px 0"},children:"我先聲明"}),e.jsx("div",{style:{display:"flex",flexWrap:"wrap",gap:"10px"},children:m.map((r,s)=>e.jsxs("label",{style:{cursor:"pointer"},children:[e.jsx("input",{type:"checkbox",checked:j[s],onChange:()=>{const t=[...j];t[s]=!t[s],A(t)}}),e.jsxs("span",{children:["#",r]})]},s))}),e.jsx("div",{style:{margin:"10px 0"},children:"外型"}),e.jsx("div",{style:{display:"flex",flexWrap:"wrap",gap:"10px"},children:g.map((r,s)=>e.jsxs("label",{style:{cursor:"pointer"},children:[e.jsx("input",{type:"checkbox",checked:b[s],onChange:()=>{const t=[...b];t[s]=!t[s],w(t)}}),e.jsxs("span",{children:["#",r]})]},s))}),e.jsxs("div",{style:{margin:"10px 0"},children:[e.jsx("label",{children:"自訂標籤"}),e.jsxs("div",{style:{display:"flex",marginTop:"4px"},children:[e.jsx("input",{type:"text",value:v,onChange:r=>S(r.target.value),style:{flex:1}}),e.jsx("button",{onClick:()=>{v.trim()&&(setAppearanceTagList(r=>[...r,v]),w(r=>[...r,!0]),S(""))},children:"+"})]})]}),e.jsxs("div",{style:{margin:"10px 0"},children:[e.jsx("label",{children:"自我介紹"}),e.jsx("textarea",{rows:3,style:{width:"100%"},value:(l==null?void 0:l.about_me)||C,onChange:r=>{l?h(s=>({...s,about_me:r.target.value})):R(r.target.value)}})]}),(l==null?void 0:l.mp3_url)&&e.jsx("div",{style:{margin:"10px 0"},children:e.jsx("audio",{controls:!0,src:l.mp3_url,style:{width:"100%"}})}),e.jsxs("div",{style:{margin:"5px 0"},children:[e.jsx("button",{style:{background:"#0088cc",color:"#fff",marginRight:"5px"},onClick:H,disabled:I,children:"開始錄音"}),e.jsx("button",{style:{background:"#0088cc",color:"#fff"},onClick:J,disabled:!I,children:"停止錄音"}),U&&e.jsxs("div",{style:{marginTop:"8px"},children:[e.jsx("audio",{src:U,controls:!0,style:{width:"100%"}}),e.jsxs("div",{style:{marginTop:"8px"},children:[e.jsx("button",{style:{background:"green",color:"#fff",marginRight:"5px"},onClick:Q,children:"確定使用此錄音"}),e.jsx("button",{style:{background:"red",color:"#fff"},onClick:K,children:"捨棄重新錄音"})]})]})]}),e.jsx("div",{style:{textAlign:"center",marginTop:"15px"},children:e.jsx("button",{style:{background:"green",color:"#fff",border:"none",padding:"8px 16px"},onClick:X,children:"送出"})}),e.jsx("div",{style:{marginTop:"10px",color:"red"},children:N})]}),e.jsx(ee,{})]})}export{ne as default};
